<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RepoForge AI - Gold Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX support -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Vanilla lucide for UMD stability -->
    <script src="https://unpkg.com/lucide@0.344.0"></script>
    <!-- JSZip for Download Functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }
        .animate-pulse-soft { animation: pulse-soft 2s infinite ease-in-out; }
        
        .thought-screen {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /**
         * Safe icon component using vanilla lucide icon definitions.
         */
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconName = name.charAt(0).toLowerCase() + name.slice(1);
            const iconData = window.lucide?.icons?.[iconName] || 
                             window.lucide?.icons?.[name.toLowerCase()] || 
                             window.lucide?.icons?.helpCircle;

            if (!iconData) return <span style={{ width: size, height: size }} className={className} />;

            const renderChildren = (children) => {
                return children.map(([tag, attrs], idx) => {
                    const reactAttrs = { ...attrs, key: idx };
                    if (reactAttrs['stroke-width']) {
                        reactAttrs.strokeWidth = reactAttrs['stroke-width'];
                        delete reactAttrs['stroke-width'];
                    }
                    if (reactAttrs['stroke-linecap']) {
                        reactAttrs.strokeLinecap = reactAttrs['stroke-linecap'];
                        delete reactAttrs['stroke-linecap'];
                    }
                    if (reactAttrs['stroke-linejoin']) {
                        reactAttrs.strokeLinejoin = reactAttrs['stroke-linejoin'];
                        delete reactAttrs['stroke-linejoin'];
                    }
                    return React.createElement(tag, reactAttrs);
                });
            };

            return (
                <svg
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                >
                    {renderChildren(iconData[2])}
                </svg>
            );
        };

        const App = () => {
            const [ghToken, setGhToken] = useState(localStorage.getItem('gh_token') || '');
            const [geminiKey, setGeminiKey] = useState(localStorage.getItem('gemini_key') || '');
            const [repoName, setRepoName] = useState('');
            
            // Structured Prompt States
            const [aiInputs, setAiInputs] = useState({
                task: '',
                outcome: '',
                constraints: ''
            });

            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('html');
            const [status, setStatus] = useState({ type: '', message: '' });
            const [isProcessing, setIsProcessing] = useState(false);
            const [processStep, setProcessStep] = useState('');
            const [isPreviewOpen, setIsPreviewOpen] = useState(false);
            const [showAiPanel, setShowAiPanel] = useState(false);

            const [files, setFiles] = useState({
                html: { content: '<!DOCTYPE html>\n<html>\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<script src="https://cdn.tailwindcss.com"><\/script>\n</head>\n<body class="p-10 bg-slate-50">\n <div class="bg-white p-8 rounded-3xl shadow-xl max-w-md mx-auto text-center border-t-8 border-indigo-600">\n  <h1 class="text-3xl font-black text-slate-900 uppercase">Forge Ready</h1>\n  <p class="text-slate-500 mt-2">Use the Structured AI Workbench to define your PWA.</p>\n </div>\n</body>\n</html>', sha: null },
                react: { content: '// app.js\nconsole.log("PWA Logic initialized.");', sha: null },
                manifest: { content: '{\n "name": "RepoForge App",\n "short_name": "App",\n "display": "standalone",\n "start_url": ".",\n "background_color": "#ffffff",\n "theme_color": "#4f46e5"\n}', sha: null },
                sw: { content: '// sw.js\nself.addEventListener("fetch", (e) => {\n  e.respondWith(fetch(e.request));\n});', sha: null },
                readme: { content: '# My PWA Project\n\nGenerated with **RepoForge Gold Edition**.', sha: null },
                script: { content: '// script.gs\n// Google Apps Script integration code here\nfunction onOpen() {\n  console.log("Script loaded");\n}', sha: null }
            });

            const fileMap = {
                html: 'index.html',
                react: 'app.js',
                manifest: 'manifest.json',
                sw: 'sw.js',
                readme: 'README.md',
                script: 'script.gs'
            };

            useEffect(() => {
                if (ghToken) { 
                    localStorage.setItem('gh_token', ghToken); 
                    fetchGithubUser(); 
                }
            }, [ghToken]);

            useEffect(() => {
                if (geminiKey) localStorage.setItem('gemini_key', geminiKey);
            }, [geminiKey]);

            const showStatus = (type, message) => {
                setStatus({ type, message });
                setTimeout(() => setStatus({ type: '', message: '' }), 8000);
            };

            const fetchGithubUser = async () => {
                if (!ghToken) return;
                try {
                    const res = await fetch('https://api.github.com/user', {
                        headers: { Authorization: `token ${ghToken}` }
                    });
                    if (res.ok) setUser(await res.json());
                } catch (e) { showStatus('error', 'GitHub Authentication failed'); }
            };

            const generateWithGemini = async () => {
                if (!geminiKey || !aiInputs.task) return showStatus('error', 'Please provide an API Key and Task');
                setIsProcessing(true);
                setProcessStep('Gemini is brainstorming architecture...');

                const systemPrompt = `You are an elite PWA and Google Apps Script engineer.
                I will provide a Task, Expected Outcome, and Constraints.
                
                You must return a JSON object with:
                - html: index.html using Tailwind CSS.
                - react: Complete JavaScript logic.
                - manifest: manifest.json.
                - sw: Service Worker code.
                - readme: Professional README.md.
                - script: Apps Script (.gs) logic for any backend tasks requested.

                The PWA must be high-end, responsive for Honor X6b, and professional.`;

                const promptPayload = `
                    TASK: ${aiInputs.task}
                    EXPECTED OUTCOME: ${aiInputs.outcome}
                    CONSTRAINTS/RISKS: ${aiInputs.constraints}
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptPayload }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        html: { type: "STRING" },
                                        react: { type: "STRING" },
                                        manifest: { type: "STRING" },
                                        sw: { type: "STRING" },
                                        readme: { type: "STRING" },
                                        script: { type: "STRING" }
                                    },
                                    required: ["html", "react", "manifest", "sw", "readme", "script"]
                                }
                            }
                        })
                    });
                    
                    if (!response.ok) throw new Error("AI Generation failed. Check API key.");
                    
                    setProcessStep('Decoding forged assets...');
                    const result = await response.json();
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    setFiles({
                        html: { content: data.html, sha: files.html.sha },
                        react: { content: data.react, sha: files.react.sha },
                        manifest: { content: data.manifest, sha: files.manifest.sha },
                        sw: { content: data.sw, sha: files.sw.sha },
                        readme: { content: data.readme, sha: files.readme.sha },
                        script: { content: data.script, sha: files.script.sha }
                    });
                    
                    setProcessStep('Forge Complete!');
                    setTimeout(() => {
                        setIsProcessing(false);
                        setShowAiPanel(false);
                    }, 1000);
                } catch (err) {
                    setIsProcessing(false);
                    showStatus('error', err.message);
                }
            };

            const downloadZip = async () => {
                if (!repoName) return showStatus('error', 'Enter a Project Name first');
                try {
                    showStatus('info', 'Zipping Project...');
                    const zip = new JSZip();
                    Object.entries(fileMap).forEach(([key, filename]) => {
                        zip.file(filename, files[key].content);
                    });
                    const blob = await zip.generateAsync({ type: "blob" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${repoName.toLowerCase()}.zip`;
                    a.click();
                    showStatus('success', 'Project Downloaded to Honor X6b');
                } catch (e) { showStatus('error', 'ZIP Engine failed'); }
            };

            const handleDeploy = async () => {
                if (!repoName || !ghToken || !user) return showStatus('error', 'Configuration missing');
                setIsProcessing(true);
                setProcessStep(`Connecting to GitHub: ${user.login}...`);

                try {
                    // Check if repo exists
                    const repoCheck = await fetch(`https://api.github.com/repos/${user.login}/${repoName}`, {
                        headers: { Authorization: `token ${ghToken}` }
                    });

                    if (!repoCheck.ok) {
                        setProcessStep('Creating new Repository...');
                        await fetch('https://api.github.com/user/repos', {
                            method: 'POST',
                            headers: { Authorization: `token ${ghToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: repoName, auto_init: false })
                        });
                    }

                    // Push files
                    for (const [key, filename] of Object.entries(fileMap)) {
                        setProcessStep(`Committing ${filename}...`);
                        const body = {
                            message: `RepoForge Sync: ${aiInputs.task.substring(0, 15) || 'Update'}`,
                            content: btoa(unescape(encodeURIComponent(files[key].content))),
                        };
                        
                        // We need the latest SHA for every commit if the file exists
                        const fileRes = await fetch(`https://api.github.com/repos/${user.login}/${repoName}/contents/${filename}`, {
                            headers: { Authorization: `token ${ghToken}` }
                        });
                        if (fileRes.ok) {
                            const fileData = await fileRes.json();
                            body.sha = fileData.sha;
                        }

                        const res = await fetch(`https://api.github.com/repos/${user.login}/${repoName}/contents/${filename}`, {
                            method: 'PUT',
                            headers: { Authorization: `token ${ghToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });

                        if (!res.ok) console.warn(`Conflict on ${filename}`);
                        await new Promise(r => setTimeout(r, 800)); // Rate limiting safety
                    }

                    setProcessStep('Activating GitHub Pages...');
                    await fetch(`https://api.github.com/repos/${user.login}/${repoName}/pages`, {
                        method: 'POST',
                        headers: { Authorization: `token ${ghToken}`, 'Accept': 'application/vnd.github.v3+json' },
                        body: JSON.stringify({ source: { branch: 'main', path: '/' } })
                    });

                    setProcessStep('Deployment Finalized!');
                    setTimeout(() => setIsProcessing(false), 2000);
                    showStatus('success', 'Project Synced & Pages enabled!');
                } catch (e) { 
                    setIsProcessing(false);
                    showStatus('error', 'Sync Failed. Please use Download ZIP.'); 
                }
            };

            return (
                <div className="min-h-screen pb-44 bg-slate-50">
                    {/* Thought Screen Overlay */}
                    {isProcessing && (
                        <div className="fixed inset-0 z-[100] thought-screen flex flex-col items-center justify-center p-8 text-center animate-in">
                            <div className="w-24 h-24 bg-indigo-600 rounded-[2.5rem] flex items-center justify-center shadow-2xl shadow-indigo-500/50 mb-8 animate-pulse-soft">
                                <Icon name="Cpu" className="text-white" size={48} />
                            </div>
                            <h2 className="text-white text-2xl font-black uppercase tracking-tighter mb-2">Architecting...</h2>
                            <p className="text-indigo-300 font-mono text-sm uppercase tracking-widest">{processStep}</p>
                            <div className="mt-12 flex gap-1">
                                <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce"></div>
                                <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                                <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="px-6 py-6 glass border-b sticky top-0 z-50 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-100 rotate-2">
                                <Icon name="Zap" className="text-white" />
                            </div>
                            <div>
                                <h1 className="text-lg font-black tracking-tighter uppercase leading-none italic">RepoForge</h1>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Structured Forge v3</p>
                            </div>
                        </div>
                        <button 
                            onClick={() => setShowAiPanel(!showAiPanel)}
                            className={`w-12 h-12 rounded-2xl transition-all flex items-center justify-center shadow-sm ${showAiPanel ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 border'}`}
                        >
                            <Icon name={showAiPanel ? "X" : "Sparkles"} size={20} />
                        </button>
                    </header>

                    <main className="p-4 space-y-4 max-w-lg mx-auto">
                        {/* Config Card */}
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border space-y-4">
                            <div className="relative">
                                <Icon name="Settings" className="absolute left-4 top-4 text-slate-400" size={18} />
                                <input 
                                    type="password" placeholder="GitHub PAT Token" value={ghToken} onChange={e => setGhToken(e.target.value)}
                                    className="w-full bg-slate-50 p-4 pl-12 rounded-2xl text-xs font-mono outline-none focus:ring-2 ring-indigo-500"
                                />
                            </div>
                            <div className="flex gap-2">
                                <input 
                                    type="text" placeholder="Project Name" value={repoName} onChange={e => setRepoName(e.target.value)}
                                    className="flex-1 bg-slate-50 p-4 rounded-2xl font-bold outline-none focus:ring-2 ring-indigo-500 uppercase"
                                />
                                <button onClick={downloadZip} className="bg-indigo-600 p-4 rounded-2xl text-white active:scale-90 transition-all shadow-lg shadow-indigo-200">
                                    <Icon name="FileArchive" size={24} />
                                </button>
                            </div>
                        </div>

                        {/* Structured AI Architecture Panel */}
                        {showAiPanel && (
                            <div className="bg-slate-900 p-6 rounded-[2.5rem] shadow-2xl text-white space-y-6 animate-in border border-slate-800">
                                <div className="flex items-center gap-3">
                                    <Icon name="Cpu" size={20} className="text-indigo-400" />
                                    <h2 className="font-black text-xs uppercase tracking-[0.2em] text-indigo-200">Architecture Definition</h2>
                                </div>
                                
                                <input 
                                    type="password" placeholder="Gemini API Key" value={geminiKey} onChange={e => setGeminiKey(e.target.value)}
                                    className="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-xs outline-none"
                                />

                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[10px] font-black uppercase text-indigo-400/60 ml-3">1. The Task</label>
                                        <textarea 
                                            placeholder="Ex: Building a Calorie Counter app..." 
                                            value={aiInputs.task} 
                                            onChange={e => setAiInputs({...aiInputs, task: e.target.value})}
                                            className="w-full bg-white/5 border border-white/10 p-4 rounded-2xl font-bold h-20 outline-none mt-1 focus:bg-white/10"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black uppercase text-indigo-400/60 ml-3">2. The Outcome</label>
                                        <textarea 
                                            placeholder="Features: Charts, dark mode, persistence..." 
                                            value={aiInputs.outcome} 
                                            onChange={e => setAiInputs({...aiInputs, outcome: e.target.value})}
                                            className="w-full bg-white/5 border border-white/10 p-4 rounded-2xl font-bold h-20 outline-none mt-1 focus:bg-white/10"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black uppercase text-indigo-400/60 ml-3">3. Risks / Constraints</label>
                                        <textarea 
                                            placeholder="Honor X6b screen size, offline usage..." 
                                            value={aiInputs.constraints} 
                                            onChange={e => setAiInputs({...aiInputs, constraints: e.target.value})}
                                            className="w-full bg-white/5 border border-white/10 p-4 rounded-2xl font-bold h-20 outline-none mt-1 focus:bg-white/10"
                                        />
                                    </div>
                                </div>

                                <button 
                                    onClick={generateWithGemini}
                                    className="w-full bg-indigo-600 py-5 rounded-3xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3"
                                >
                                    <Icon name="Sparkles" size={20} /> Forge PWA Assets
                                </button>
                            </div>
                        )}

                        {/* Editor Module */}
                        <div className="bg-white rounded-[3rem] overflow-hidden border shadow-sm">
                            <div className="flex p-2 bg-slate-50 border-b overflow-x-auto no-scrollbar gap-1">
                                {Object.keys(fileMap).map(tab => (
                                    <button
                                        key={tab} onClick={() => { setActiveTab(tab); setIsPreviewOpen(false); }}
                                        className={`px-5 py-3 rounded-2xl font-black text-[10px] uppercase transition-all whitespace-nowrap ${activeTab === tab && !isPreviewOpen ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-400'}`}
                                    >
                                        {tab === 'react' ? 'Logic' : tab === 'script' ? 'AppScript' : tab}
                                    </button>
                                ))}
                            </div>
                            <div className="relative">
                                {isPreviewOpen ? (
                                    <iframe 
                                        srcDoc={files.html.content + '<script>' + files.react.content + '<\/script>'} 
                                        className="w-full h-[500px] border-none" 
                                        title="Preview" 
                                    />
                                ) : (
                                    <div className="bg-[#0F172A] p-4">
                                        <textarea
                                            value={files[activeTab].content}
                                            onChange={e => setFiles({...files, [activeTab]: {...files[activeTab], content: e.target.value}})}
                                            className="w-full h-[500px] bg-transparent text-indigo-300 font-mono text-xs outline-none resize-none leading-relaxed"
                                            spellCheck="false"
                                        />
                                    </div>
                                )}
                                <button 
                                    onClick={() => setIsPreviewOpen(!isPreviewOpen)}
                                    className={`absolute bottom-6 right-6 p-4 rounded-2xl shadow-2xl flex items-center gap-3 z-10 ${isPreviewOpen ? 'bg-rose-500 text-white' : 'bg-white text-slate-900 border'}`}
                                >
                                    <Icon name={isPreviewOpen ? "Code2" : "Eye"} size={24} />
                                    <span className="text-[10px] font-black uppercase tracking-widest">{isPreviewOpen ? 'Edit' : 'Preview'}</span>
                                </button>
                            </div>
                        </div>

                        {status.message && (
                            <div className={`p-5 rounded-3xl flex items-center gap-4 border-2 transition-all ${status.type === 'error' ? 'bg-rose-50 border-rose-100 text-rose-600' : 'bg-indigo-50 border-indigo-100 text-indigo-600'}`}>
                                <Icon name="AlertCircle" size={24} />
                                <span className="text-xs font-black uppercase tracking-tight">{status.message}</span>
                            </div>
                        )}
                    </main>

                    {/* Honor X6b Navigation Dock */}
                    <footer className="fixed bottom-0 left-0 right-0 p-6 glass border-t z-50 flex gap-3 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] items-center">
                        {repoName && user && (
                            <div className="flex gap-2">
                                <a href={`https://${user.login}.github.io/${repoName}`} target="_blank" className="w-16 h-16 bg-indigo-600 border rounded-2xl flex flex-col items-center justify-center active:scale-90 transition-all shadow-lg shadow-indigo-200">
                                    <Icon name="Globe" size={24} className="text-white" />
                                    <span className="text-[7px] font-black uppercase mt-1 text-white opacity-80">Live</span>
                                </a>
                                <a href={`https://github.com/${user.login}/${repoName}`} target="_blank" className="w-16 h-16 bg-white border rounded-2xl flex flex-col items-center justify-center active:scale-90 transition-all">
                                    <Icon name="Github" size={24} className="text-slate-600" />
                                    <span className="text-[7px] font-black uppercase mt-1 text-slate-400">Repo</span>
                                </a>
                            </div>
                        )}
                        <button 
                            onClick={handleDeploy} disabled={isProcessing || !repoName || !ghToken}
                            className="flex-1 bg-indigo-600 h-16 text-white rounded-2xl font-black uppercase tracking-[0.2em] shadow-xl active:scale-95 transition-all flex items-center justify-center gap-4 disabled:bg-slate-300"
                        >
                            <Icon name="Upload" size={24} /> Sync GitHub
                        </button>
                    </footer>

                    <style dangerouslySetInnerHTML={{ __html: `
                        .no-scrollbar::-webkit-scrollbar { display: none; }
                        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
                        @keyframes slideIn {
                            from { transform: translateY(20px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                        .animate-in { animation: slideIn 0.3s ease-out forwards; }
                    `}} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>